!function(t,e){function n(t){this.endpoint=t&&t.endpoint||"",e.proxyAll(this,/parse/)}e.extend(n.prototype,{url:function(t){return/^https?:\/\//i.test(t)||(t=this.endpoint+"/"+t.replace(/^\//,"")),t},call:function(t,n,r,a,i){var o={contentType:"application/json",url:this.url("/api/action/"+n),dataType:"json",processData:!1,success:a,error:i="undefined"==i?function(){}:i};"POST"==t?(o.type="POST",o.data=JSON.stringify(r)):(o.type="GET",o.url+=r),e.ajax(o)},getTemplate:function(t,n,r,a){var i=this.url("/api/1/util/snippet/"+encodeURIComponent(t));return"function"==typeof n&&(a=r,r=n,n={}),e.get(i,n||{}).then(r,a)},getLocaleData:function(t,n,r){var a=this.url("/api/i18n/"+(t||""));return e.getJSON(a).then(n,r)},getCompletions:function(t,n,r,a){"function"==typeof n&&(a=r,r=n,n={});var i=n&&n.format||this.parseCompletions,o=e.ajax({url:this.url(t)});return o.pipe(i).promise(o).then(r,a)},parseCompletions:function(t,n){if("string"==typeof t)return this.parsePackageCompletions(t,n);var r={},a=e.isArray(t)?t:t.ResultSet&&t.ResultSet.Result||{},i=e.map(a,(function(t){var a=void 0!==n.key&&t[n.key],i=void 0!==n.label&&t[n.label];t="string"==typeof t?t:t.name||t.Name||t.Format||"",t=e.trim(t),a=a||t,i=i||t;var o=t.toLowerCase(),s=n&&!0===n.objects;return o&&!r[o]?(r[o]=1,s?{id:a,text:i}:t):null}));return i=e.grep(i,(function(t){return null!==t}))},parseCompletionsForPlugin:function(t){return{results:this.parseCompletions(t,{objects:!0})}},parsePackageCompletions:function(t,n){var r=e.trim(t).split("\n");return e.map(r,(function(t){var r=t.split("|"),a=e.trim(r.pop()||""),i=e.trim(r.join("|")||"");return n&&!0===n.objects?{id:a,text:i}:a}))},getStorageAuth:function(t,n,r){if(!t)throw new Error("Client#getStorageAuth() must be called with a key");return e.ajax({url:this.url("/api/storage/auth/form/"+t),success:n,error:r})},getStorageMetadata:function(t,n,r){if(!t)throw new Error("Client#getStorageMetadata() must be called with a key");return e.ajax({url:this.url("/api/storage/metadata/"+t),success:n,error:r})},convertStorageMetadataToResource:function(n){var r=new Date(this.normalizeTimestamp(n._last_modified)),a=new Date(this.normalizeTimestamp(n._creation_date)),i=e.date.toCKANString(a),o=e.date.toCKANString(r),s=n["filename-original"]||n.key,u=n._format||s.split(".").pop(),l=n._location;return-1===l.indexOf("://")&&(l=t.url(l)),{url:l,key:n.key,name:s,size:n._content_length,created:i,last_modified:o,format:u,mimetype:n._format||null,resource_type:"file.upload",owner:n["uploaded-by"],hash:n._checksum,cache_url:n._location,cache_url_updated:o}},normalizeTimestamp:function(t){return/[+\-]\d{4}|Z/.test(t)||(t+="Z"),t}}),t.sandbox.setup((function(e){e.client=new n({endpoint:t.SITE_ROOT})})),t.Client=n}(this.ckan,this.jQuery);