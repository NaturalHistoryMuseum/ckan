window.popover_context={dict:{user:{},dataset:{},group:{}},render:{user:{},dataset:{},group:{}}},this.ckan.module("popover-context",(function(o){return{options:{id:null,loading:!1,error:!1,authed:!1,throbber:'<img src="{SITE_ROOT}/base/images/loading-spinner.gif">'},initialize:function(){1!=this.options.id&&null!=this.options.id&&(o.proxyAll(this,/_on/),o(".account").hasClass("authed")&&(this.options.authed=o(".account").data("me")),this.el.popover({animation:!1,html:!0,content:this.options.throbber.replace("{SITE_ROOT}",ckan.SITE_ROOT)+this._("Loading..."),placement:"bottom"}),this.el.on("mouseover",this._onMouseOver),o(document).on("mouseup",this._onDocumentMouseUp),this.sandbox.subscribe("follow-follow-"+this.options.id,this._onHandleFollow),this.sandbox.subscribe("follow-unfollow-"+this.options.id,this._onHandleFollow))},_onDocumentMouseUp:function(o){var t=this.el.data("popover");void 0!==t.$tip&&0===t.$tip.has(o.target).length&&this.el.popover("hide")},loadingHelper:function(o){this.options.loading=o;var t=this.el.data("popover");void 0!==t.$tip&&(o?t.$tip.addClass("popover-context-loading"):t.$tip.removeClass("popover-context-loading"))},_onMouseOver:function(){o('[data-module="popover-context"]').popover("hide"),this.el.popover("show"),this.getData()},getData:function(){if(!this.options.loading){this.loadingHelper(!0);var o=this.options.id,t=this.options.type;if(void 0===window.popover_context.dict[t][o]){var e=t+"_show";"dataset"==t&&(e="package_show"),this.sandbox.client.call("GET",e,"?id="+o,this._onHandleData,this._onHandleError)}else this._onHandleData(window.popover_context.dict[t][o])}},_onHandleError:function(t){o('[data-module="popover-context"][data-module-type="'+this.options.type+'"][data-module-id="'+this.options.id+'"]').popover("destroy")},_onHandleData:function(o){if(o.success){var t=this.options.id,e=this.options.type,i=this.sandbox.client;if(window.popover_context.dict[e][t]=o,void 0===window.popover_context.render[e][t]){var n=this.sanitiseParams(o.result);i.getTemplate("popover_context_"+e+".html",n,this._onRenderPopover)}else this._onRenderPopover(window.popover_context.render[e][t])}},sanitiseParams:function(o){var t=this.options.type,e={};return"user"==t?(e.id=o.id,e.name=o.name,e.about=o.about,e.display_name=o.display_name,e.num_followers=o.num_followers,e.number_administered_packages=o.number_administered_packages,e.number_of_edits=o.number_of_edits,e.is_me=o.id==this.options.authed):"dataset"==t?(e.id=o.id,e.title=o.title,e.name=o.name,e.notes=o.notes,e.num_resources=o.num_resources,e.num_tags=o.num_tags):"group"==t&&(e.id=o.id,e.title=o.title,e.name=o.name,e.description=o.description,e.package_count=o.package_count,e.num_followers=o.num_followers),e},_onRenderPopover:function(t){var e=this.options.id,i=this.options.type,n=window.popover_context.dict[i][e].result,s=this.el.data("popover");if(void 0!==s.$tip){var a=s.$tip,p="user"==i?n.display_name:n.title;o(".popover-title",a).html('<a href="javascript:;" class="popover-close">&times;</a>'+p),o(".popover-content",a).html(t),o(".popover-close",a).on("click",this._onClickPopoverClose);var r=this.getFollowButton();r&&ckan.module.initializeElement(r[0]),this.loadingHelper(!1)}window.popover_context.render[i][e]=t},_onClickPopoverClose:function(){this.el.popover("hide")},getFollowButton:function(){var t=this.el.data("popover");if(void 0!==t.$tip){var e=o('[data-module="follow"]',t.$tip);if(e.length>0)return e}return!1},_onHandleFollow:function(){delete window.popover_context.render[this.options.type][this.options.id]}}}));