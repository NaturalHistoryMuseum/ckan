this.ckan.module("resource-upload-field",(function(o){return{options:{form:{method:"POST",file:"file",params:[]},template:['<span class="resource-upload-field">','<i class="ckan-icon ckan-icon-link-plugin"></i>','<input type="file" />','<input id="field-resource-type-upload" type="radio" name="resource_type" value="file.upload" />','<label class="radio inline" for="field-resource-type-upload"></label>',"</span>"].join("\n")},initialize:function(){o.proxyAll(this,/_on/),this.upload=o(this.options.template),this.setupFileUpload(),this.el.append(this.upload),o(window).on("beforeunload",this._onWindowUpload)},setupFileUpload:function(){var o=this.options;this.upload.find("label").text(this._("Upload a file")),this.upload.find("input[type=file]").fileupload({type:o.form.method,paramName:o.form.file,forceIframeTransport:!0,replaceFileInput:!0,autoUpload:!1,add:this._onUploadAdd,send:this._onUploadSend,done:this._onUploadDone,fail:this._onUploadFail,always:this._onUploadComplete})},loading:function(o){this.upload.toggleClass("loading",o)},authenticate:function(t,n){n.key=t;var a=this.sandbox.client.getStorageAuth(t),i=o.proxy(this._onAuthSuccess,this,n);return a.then(i,this._onAuthError)},lookupMetadata:function(t,n){var a=this.sandbox.client.getStorageMetadata(t),i=o.proxy(this._onMetadataSuccess,this,n);return a.then(i,this._onMetadataError)},notify:function(o,t){var n=this._("An Error Occurred");this.sandbox.notify(n,o,t)},generateKey:function(t){var n=t.split("."),a=o.url.slugify(n.pop());return t=o.url.slugify(n.join("."))+"."+a,o.date.toISOString()+"/"+t},uploading:function(t){var n=t?"on":"off";o(window)[n]("beforeunload",this._onWindowBeforeUnload)},_onUploadAdd:function(o,t){if(this.uploading(!0),t.files&&t.files.length){var n=this.generateKey(t.files[0].name);this.authenticate(n,t)}},_onUploadFail:function(){this.sandbox.notify(this._("Unable to upload file"))},_onUploadSend:function(){this.loading()},_onUploadDone:function(t,n){var a=n.result;!a||o.isPlainObject(a)&&a.error?this._onUploadFail(t,n):this.lookupMetadata(n.key,n)},_onUploadComplete:function(){this.loading(!1),this.uploading(!1)},_onAuthSuccess:function(o,t){o.url=t.action,o.formData=this.options.form.params.concat(t.fields),o.submit()},_onAuthError:function(o,t){this.sandbox.notify(this._("Unable to authenticate upload")),this._onUploadComplete()},_onMetadataSuccess:function(o,t){var n=this.sandbox.client.convertStorageMetadataToResource(t);this.sandbox.notify(this._("Resource uploaded"),"","success"),this.sandbox.publish("resource:uploaded",n)},_onMetadataError:function(){this.sandbox.notify(this._("Unable to get data for uploaded file")),this._onUploadComplete()},_onWindowBeforeUnload:function(o){var t=this._("You are uploading a file. Are you sure you want to navigate away and stop this upload?");return o.originalEvent.returnValue&&(o.originalEvent.returnValue=t),t}}}));