this.ckan.module("recline_view",(function(e){var i=Backbone.View.extend({template:'<div class="recline-norecords">{{text}}</div>',render:function(){var e=Mustache.render(this.template,{text:this.options.i18n.noRecords});this.$el.html(e)}});return{options:{site_url:"",controlsClassName:"controls"},initialize:function(){e.proxyAll(this,/_on/),this.options.resource=JSON.parse(this.options.resource),this.options.resourceView=JSON.parse(this.options.resourceView),this.el.ready(this._onReady),L.Icon.Default.imagePath=this.options.site_url+"vendor/leaflet/0.7.7/images"},_onReady:function(){var e=this.options.resource,i=this.options.resourceView;this.loadView(e,i)},loadView:function(i,t){var a,o,n=this;if(""===i.formatNormalized){var r=i.url.split("/"),s=(r=(r=(r=r[r.length-1]).split("?"))[0]).split(".");s.length>1&&(i.formatNormalized=s[s.length-1])}i.datastore_active?(i.backend="ckan",i.endpoint=e("body").data("site-root")+"api"):(recline.Backend.DataProxy.timeout=1e4,i.backend="dataproxy"),o=new recline.Model.Dataset(i),this.options.map_config;var l=new recline.Model.Query;l.set({size:t.limit||100}),l.set({from:t.offset||0});var d={};try{window.parent.ckan.views&&window.parent.ckan.views.filters&&(d=window.parent.ckan.views.filters.get())}catch(e){}var p=t.filters||{},c=e.extend({},p,d);e.each(c,(function(e,i){l.addFilter({type:"term",field:e,term:i})})),window.parent.ckan.views.filters._searchParams.q&&l.set({q:window.parent.ckan.views.filters._searchParams.q}),o.queryState.set(l.toJSON(),{silent:!0}),a=this._("Could not load view")+": ","ckan"==i.backend?a+=this._("DataStore returned an error"):"dataproxy"==i.backend&&(a+=this._("DataProxy returned an error")),o.fetch().done((function(e){n.initializeView(e,t)})).fail((function(e){var i;e.message&&(a+=" ("+e.message+")"),i=(i=a)||n._("error loading view"),window.parent.ckan.pubsub.publish("data-viewer-error",i)}))},initializeView:function(t,a){var o,n,r=[];if(void 0===t.recordCount||0==t.recordCount?o=new i({model:t,i18n:{noRecords:this.options.i18n.noRecords}}):"recline_graph_view"===a.view_type?(n={graphType:a.graph_type,group:a.group,series:[a.series]},o=new recline.View.Graph({model:t,state:n})):"recline_map_view"===a.view_type?(n={geomField:null,latField:null,lonField:null,autoZoom:Boolean(a.auto_zoom),cluster:Boolean(a.cluster_markers)},"geojson"===a.map_field_type?n.geomField=a.geojson_field:(n.latField=a.latitude_field,n.lonField=a.longitude_field),o=new recline.View.Map($.extend(this._reclineMapViewOptions(t,this.options.map_config),{state:n}))):"recline_view"===a.view_type?o=this._newDataExplorer(t,this.options.map_config):(void 0===a.state?a.state={}:e.each(["defaultFormatter","formatterFactory","editorFactory"],(function(e,i){void 0!==a.state.gridOptions[i]&&(a.state.gridOptions[i]=window[a.state.gridOptions[i]])})),o=new recline.View.SlickGrid({model:t,state:a.state}),r=[new recline.View.Pager({model:o.model}),new recline.View.RecordCount({model:t}),new recline.View.QueryEditor({model:o.model.queryState})]),"recline_view"!==a.view_type){var s=e("<div />");this._renderControls(s,r,this.options.controlsClassName),s.append(o.el),e(this.el).html(s),o.visible=!0,o.render()}"recline_graph_view"===a.view_type&&o.redraw()},_reclineMapViewOptions:function(e,i){var t,a,o;if(t=a=o="","mapbox"==i.type){if(!i["mapbox.map_id"]||!i["mapbox.access_token"])throw"[CKAN Map Widgets] You need to provide a map ID ([account].[handle]) and an access token when using a MapBox layer. See http://www.mapbox.com/developers/api-overview/ for details";t="//{s}.tiles.mapbox.com/v4/"+i["mapbox.map_id"]+"/{z}/{x}/{y}.png?access_token="+i["mapbox.access_token"],handle=i["mapbox.map_id"],o=i.subdomains||"abcd",a=i.attribution||'Data: <a href="http://osm.org/copyright" target="_blank">OpenStreetMap</a>, Design: <a href="http://mapbox.com/about/maps" target="_blank">MapBox</a>'}else if("custom"==i.type&&(t=i["custom.url"]||"",a=i.attribution||"",o=i.subdomains||"",i["custom.tms"]))i["custom.tms"];return{model:e,mapTilesURL:t,mapTilesAttribution:a,mapTilesSubdomains:o}},_newDataExplorer:function(e,i){var t=[{id:"grid",label:this._("Grid"),view:new recline.View.SlickGrid({model:e})},{id:"graph",label:this._("Graph"),view:new recline.View.Graph({model:e})},{id:"map",label:this._("Map"),view:new recline.View.Map(this._reclineMapViewOptions(e,i))}],a=[{id:"valueFilter",label:this._("Filters"),view:new recline.View.ValueFilter({model:e})}];return new recline.View.MultiView({el:this.el,model:e,views:t,sidebarViews:a,config:{readOnly:!0}})},_renderControls:function(i,t,a){for(var o=e('<div class="clearfix '+a+'" />'),n=0;n<t.length;n++)o.append(t[n].el);e(i).append(o)}}}));